<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    <title>Conveyor Calculator</title>
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" sizes="180x180" href="icon.png">

    <!-- Shortcut Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icon-16x16.png">

    <link rel="manifest" href="manifest.json">

    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
           background-color: black;
        }
        body {
            background-image: url('background.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            font-weight: bold;
        }

        .bold { font-weight: bold; }
        .input-small { width: 6rem; }
        .red { color: red; }
        .green { color: green; }
        .blue { color: blue; }
        .purple { color: purple; }
        .orange { color: orange; }

        .content {
            background-color: rgba(255, 255, 255, 0.7);
            padding: 20px;
            border-radius: 10px;
        }

        #recordLap1, #recordLap2 {
            width: auto;
            height: auto;
            font-size: 230%;
        }

        /* Increase the size of Conveyor headers by 50% */
        .conveyor-header {
            font-size: 180%;
        }
    </style>
</head>
<body>
    <div class="content">
        <h1 style="font-size: 2.2rem;">Conveyor Calculator</h1>
        <button id="startConveyor1">Start Conveyor 1</button>
        <button id="startConveyor2">Start Conveyor 2</button>
        <button id="recordLap1">Lap Conveyor 1</button>
        <button id="recordLap2">Lap Conveyor 2</button>
        <input type="time" id="timeInput" class="input-small">
        <button id="setTime">  Set End Shift </button>
    </div>
    <div id="stats" class="content">
        <!-- Display statistics here -->
    </div>

    <script>
        let lapStart1 = 0;
        let lapStart2 = 0;
        let running1 = false;
        let running2 = false;
        const lapTimes1 = [];
        const lapTimes2 = [];
        let timeDifference = 0;
        let timeDifferenceRemaining = 0;
        let workToBeDone1 = 0;
        let workToBeDone2 = 0;
        let targetTime = 0;
        let countdownInterval;

        function displayStats() {
            const statsDiv = document.getElementById('stats');
            statsDiv.innerHTML = '';

            function formatTime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secondsStr = Math.floor(seconds % 60);
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secondsStr.toString().padStart(2, '0')}`;
            }

            statsDiv.innerHTML += '<div class="red conveyor-header">Conveyor 1:</div>';
            if (lapTimes1.length > 0) {
                const averageTime1 = calculateAverageTime(lapTimes1);
                statsDiv.innerHTML += `<div class="green">Average Lap TimeAll: ${formatTime(averageTime1)}</div>`;
                statsDiv.innerHTML += `<div class="black">Average Last 4 Laps:  ${formatTime(calculateAverageTimeX4(lapTimes1))} </div>`;
                statsDiv.innerHTML += `<div class="green">Average Last 2 Laps:  ${formatTime(calculateAverageTimeX2(lapTimes1))} </div>`;
                
            }
            statsDiv.innerHTML += '<div class="blue">Lap times:</div>';
            lapTimes1.slice().reverse().forEach((lapData, idx) => {
                const lapTimeStr = formatTime(Math.floor(lapData[0] / 1000));
                statsDiv.innerHTML += `<div class="purple">${lapTimes1.length - idx}. ${lapTimeStr} (${lapData[1]})</div>`;
            });

            if (running1) {
                const runningTime = Math.floor((Date.now() - lapStart1) / 1000);
                statsDiv.innerHTML += '<div class="black bold">Conveyor 1 is running</div>';
                statsDiv.innerHTML += `<div class="blue bold">Current lap time: ${formatTime(runningTime)}</div>`;
                if (timeDifferenceRemaining > 0) {
                    const averageTimeAll1 = calculateAverageTime(lapTimes1);
                    const averageTimeX2_1 = calculateAverageTimeX2(lapTimes1);
                    const averageTimeX4_1 = calculateAverageTimeX4(lapTimes1);

                    const workToBeDone1_All = calculateWorkToBeDone(averageTimeAll1, timeDifferenceRemaining);
                    const workToBeDone1_X2 = calculateWorkToBeDone(averageTimeX2_1, timeDifferenceRemaining);
                    const workToBeDone1_X4 = calculateWorkToBeDone(averageTimeX4_1, timeDifferenceRemaining);

                    statsDiv.innerHTML += `<div class="green">Avg All - Load Conveyor = ${workToBeDone1_All.toFixed(1)}  (Lifts = ${(workToBeDone1_All * 10 / 16).toFixed(1)})</div>`;
                    statsDiv.innerHTML += `<div class="black">Avg 4x - Load Conveyor = ${workToBeDone1_X4.toFixed(1)}  (Lifts = ${(workToBeDone1_X4 * 10 / 16).toFixed(1)})</div>`;
                    statsDiv.innerHTML += `<div class="green">Avg 2x - Load Conveyor = ${workToBeDone1_X2.toFixed(1)}  (Lifts = ${(workToBeDone1_X2 * 10 / 16).toFixed(1)})</div>`;
                    
                }
            } else {
                statsDiv.innerHTML += 'Conveyor 1 stopped';
            }

            statsDiv.innerHTML += '<div class="red conveyor-header">Conveyor 2:</div>';
            if (lapTimes2.length > 0) {
                const averageTime2 = calculateAverageTime(lapTimes2);
                statsDiv.innerHTML += `<div class="green">Average Lap TimeAll: ${formatTime(averageTime2)}</div>`;
                statsDiv.innerHTML += `<div class="black">Average Last 4 Laps:  ${formatTime(calculateAverageTimeX4(lapTimes2))} </div>`;
                statsDiv.innerHTML += `<div class="green">Average Last 2 Laps:  ${formatTime(calculateAverageTimeX2(lapTimes2))} </div>`;
            }
            statsDiv.innerHTML += '<div class="blue">Lap times:</div>';
            lapTimes2.slice().reverse().forEach((lapData, idx) => {
                const lapTimeStr = formatTime(Math.floor(lapData[0] / 1000));
                statsDiv.innerHTML += `<div class="purple">${lapTimes2.length - idx}. ${lapTimeStr} (${lapData[1]})</div>`;
            });

            if (running2) {
                const runningTime = Math.floor((Date.now() - lapStart2) / 1000);
                statsDiv.innerHTML += '<div class="black bold">Conveyor 2 is running</div>';
                statsDiv.innerHTML += `<div class="blue bold">Current lap time: ${formatTime(runningTime)}</div>`;
                if (timeDifferenceRemaining > 0) {
                    const averageTimeAll2 = calculateAverageTime(lapTimes2);
                    const averageTimeX2_2 = calculateAverageTimeX2(lapTimes2);
                    const averageTimeX4_2 = calculateAverageTimeX4(lapTimes2);

                    const workToBeDone2_All = calculateWorkToBeDone(averageTimeAll2, timeDifferenceRemaining);
                    const workToBeDone2_X2 = calculateWorkToBeDone(averageTimeX2_2, timeDifferenceRemaining);
                    const workToBeDone2_X4 = calculateWorkToBeDone(averageTimeX4_2, timeDifferenceRemaining);

                    statsDiv.innerHTML += `<div class="green">Avg All - Load Conveyor = ${workToBeDone2_All.toFixed(1)}  (Lifts = ${(workToBeDone2_All * 10 / 16).toFixed(1)})</div>`;
                    statsDiv.innerHTML += `<div class="black">Avg 4x - Load Conveyor = ${workToBeDone2_X4.toFixed(1)}  (Lifts = ${(workToBeDone2_X4 * 10 / 16).toFixed(1)})</div>`;
                    statsDiv.innerHTML += `<div class="green">Avg 2x - Load Conveyor = ${workToBeDone2_X2.toFixed(1)} (Lifts = ${(workToBeDone2_X2 * 10 / 16).toFixed(1)})</div>`;
                }
            } else {
                statsDiv.innerHTML += 'Conveyor 2 stopped';
            }

            if (timeDifferenceRemaining > 0) {
                statsDiv.innerHTML += `<div class="red bold">Time to Shift Change: ${formatTime(timeDifferenceRemaining)}</div>`;
            }
        }

        function startCountdown() {
            clearInterval(countdownInterval);
            countdownInterval = setInterval(function() {
                if (timeDifferenceRemaining > 0) {
                    timeDifferenceRemaining--;
                    displayStats();
                }
            }, 1000);
        }

        function calculateWorkToBeDone(averageTime, timeDifference) {
            return averageTime > 0 ? timeDifference / averageTime : 0;
        }

        function getFormattedTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const ampm = hours >= 12 ? 'pm' : 'am';
            const formattedTime = hours % 12 + ':' + (minutes < 10 ? '0' : '') + minutes + ' ' + ampm;
            return formattedTime;
        }

        function calculateAverageTime(lapTimes) {
            const totalLapTime = lapTimes.reduce((total, lapData) => total + lapData[0], 0);
            const numLaps = lapTimes.length;
            return numLaps > 0 ? totalLapTime / numLaps / 1000 : 0;
        }

        function calculateAverageTimeX2(lapTimes) {
            const lastTwoLaps = lapTimes.slice(-2);
            const totalLapTime = lastTwoLaps.reduce((total, lapData) => total + lapData[0], 0);
            return lastTwoLaps.length > 0 ? totalLapTime / lastTwoLaps.length / 1000 : 0;
        }

        function calculateAverageTimeX4(lapTimes) {
            const lastFourLaps = lapTimes.slice(-4);
            const totalLapTime = lastFourLaps.reduce((total, lapData) => total + lapData[0], 0);
            return lastFourLaps.length > 0 ? totalLapTime / lastFourLaps.length / 1000 : 0;
        }

        function toggleAMPM(time) {
            return time.includes('am') ? time.replace('am', 'pm') : time.replace('pm', 'am');
        }

        function setInitialTime() {
            const timeInput = document.getElementById('timeInput');
            timeInput.value = toggleAMPM('5:15 am');
        }

        // Function to simulate a click on the "Set Time" button
        function simulateSetTimeButtonClick() {
            const setTimeButton = document.getElementById('setTime');
            setTimeButton.click();
        }

        // Automatically set the initial time and click the "Set Time" button every 1 second
        setInitialTime();
        setInterval(simulateSetTimeButtonClick, 1000);

        // Event listeners for buttons
        document.getElementById('startConveyor1').addEventListener('click', () => {
            if (!running1) {
                lapStart1 = Date.now();
                running1 = true;
                startCountdown();
                displayStats();
            }
        });

        document.getElementById('startConveyor2').addEventListener('click', () => {
            if (!running2) {
                lapStart2 = Date.now();
                running2 = true;
                startCountdown();
                displayStats();
            }
        });

        document.getElementById('recordLap1').addEventListener('click', () => {
            if (running1) {
                const lapTime = Date.now() - lapStart1;
                const timeOfDay = getFormattedTime();
                lapTimes1.push([lapTime, timeOfDay]);
                lapStart1 = Date.now();
                displayStats();
            }
        });

        document.getElementById('recordLap2').addEventListener('click', () => {
            if (running2) {
                const lapTime = Date.now() - lapStart2;
                const timeOfDay = getFormattedTime();
                lapTimes2.push([lapTime, timeOfDay]);
                lapStart2 = Date.now();
                displayStats();
            }
        });

        document.getElementById('setTime').addEventListener('click', () => {
            const timeInput = document.getElementById('timeInput').value;
            const timeParts = timeInput.split(':');
            if (timeParts.length === 2) {
                const hours = parseInt(timeParts[0]);
                const minutes = parseInt(timeParts[1]);
                if (!isNaN(hours) && !isNaN(minutes)) {
                    const now = new Date();
                    targetTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
                    if (targetTime <= now) {
                        targetTime.setDate(targetTime.getDate() + 1);
                    }
                    timeDifference = targetTime.getTime() - now.getTime();
                    timeDifferenceRemaining = timeDifference / 1000;
                    workToBeDone1 = calculateWorkToBeDone(calculateAverageTime(lapTimes1), timeDifferenceRemaining);
                    workToBeDone2 = calculateWorkToBeDone(calculateAverageTime(lapTimes2), timeDifferenceRemaining);
                    displayStats();
                    startCountdown();
                }
            }
        });
    </script>
</body>
</html>
